# LCT — Lightweight Catalog Tuning (prototype)

Интеллектуальный сервис с применением языковых моделей (LLM), который анализирует SQL-запросы, логическую и физическую структуру хранилища данных и выдает рекомендации по оптимизации.

## Файлы окружения

По шаблону в `template.env` с актуальными конфигами для LLM необходимо создать файл `.env`

## Быстрый запуск — локально

1) Создайте и активируйте виртуальное окружение:

```bash
python3 -m venv venv
source venv/bin/activate
```

2) Установите зависимости:

```bash
pip install -r requirements.txt
```

3) Запустите тестовый сценарий (он сам поднимет сервер и выполнит запросы):

```bash
python3 test_api.py
```

4) Или запустите сервер вручную (для разработки):

```bash
uvicorn lct.main:app --host 127.0.0.1 --port 8080 --reload
```
## Концепция решения

Мы планируем использовать мультиагентный подход, где каждый агент выполняет свою узкоспециализированную роль. Оркестрация агентов построена на фреймворке **LangGraph**.

### Архитектура агентов

1. **Агент-исследователь**:
   - **Цель**: Выдвижение гипотез по оптимизации.
   - **Функционал**: Получает на вход DDL и SQL, обращается к базе знаний с SOTA-решениями по оптимизации (партиционирование, денормализация, индексирование и т.д.) и генерирует список наиболее релевантных гипотез.

2. **Агент-оптимизатор DDL**:
   - **Цель**: Генерация оптимизированных DDL-команд.
   - **Функционал**: Принимает лучшую гипотезу от исследователя (например, "применить партиционирование по дате") и генерирует конкретные `CREATE TABLE ... PARTITIONED BY ...` и `ALTER TABLE ...` команды с учетом специфики целевой технологии (Trino + Iceberg).

3. **Агент-оптимизатор SQL**:
   - **Цель**: Переписывание SQL-запросов.
   - **Фуционал**: На основе гипотезы переписывает исходные запросы для работы с новой, оптимизированной структурой данных. Например, заменяет фильтры по `timestamp` на фильтры по партиционным колонкам `year`, `month`, `day`.

4. **Агент-валидатор**:
   - **Цель**: Проверка корректности и эффективности предложенных изменений.
   - **Функционал**: Использует разработанный `Tool` — скрипт, который подключается к БД и выполняет `EXPLAIN` для DDL и SQL-запросов. На основе ответа от БД (успех/ошибка, оценка стоимости) агент либо подтверждает валидность решения, либо отправляет его на доработку с фидбэком.

5. **Агент-менеджер (опционально)**:
   - **Цель**: Координация процесса.
   - **Функционал**: Управляет потоком данных между агентами, обрабатывает циклы доработки (например, от валидатора к оптимизаторам) и принимает финальное решение о готовности результата.

### Технологический стек

- **Оркестрация агентов**: LangGraph
- **Бэкенд**: FastAPI
- **LLM-интеграция**: OpenAI-совместимый API (для взаимодействия с локальными или коммерческими моделями)

## Текущий статус готовности

**Важное примечание для экспертов:**

Мы столкнулись со значительными сложностями при проведении экспериментов из-за ограниченности доступных ресурсов (GPU / лимиты API коммерческих моделей). Стабильная работа и итеративная отладка мультиагентных систем требуют большого количества вызовов LLM, что в наших условиях оказалось затруднительно.

По этой причине готового промежуточного решения в виде развернутого сервиса на данный момент нет, есть только первичный прототип для тестирования реализации подхода (файл [multy_agent_prototype.py](./multy_agent_prototype.py)). Пока что мы сосредоточились на теоретическом исследовании, проработке гипотетической архитектуры решения, и создании прототипов отдельных компонентов (например [API](./api)).

Мы планируем завершить разработку и тестирование сервиса как только найём возможность воспользоваться необходимыми ресурсами.

Спасибо за понимание!
