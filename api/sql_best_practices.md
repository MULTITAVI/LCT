## Best practices оптимизации SQL под Trino

Подсказки для LLM‑агента по переписыванию запросов с учетом особенностей Trino.

### Общие принципы
- Удаляй `SELECT *`; всегда указывай только нужные колонки.
- Максимально ранний отбор: фильтры в `WHERE` ближе к источникам; избегай «держать» лишние столбцы и строки.
- Предагрегируй «build side» перед `JOIN`, если downstream все равно агрегирует.
- Удаляй `ORDER BY` в подзапросах без `LIMIT`.
- Используй точные литералы дат/времени: `date '2023-01-01'`, `timestamp '2023-01-01 00:00:00'`.

### JOIN и распределение
- Сопоставляй типы join‑ключей; избегай функций на ключах (`lower(col)` и т.п.).
- Для маленьких таблиц рекомендовать broadcast: `SET SESSION join_distribution_type = 'BROADCAST'` или убедиться, что план выберет broadcast.
- Избегай `CROSS JOIN`; если неизбежно — ограничивай кардинальность.
- Для подмножеств — `EXISTS`/`SEMI JOIN` вместо `IN` с большим подзапросом; отрицание — `NOT EXISTS`.
- Ликвидируй skew: «соль» (salting) для «горячих» ключей или перетасовка распределения.

### Агрегации и distinct
- Удаляй `DISTINCT`, если дальше есть `GROUP BY` по тем же полям.
- Для очень больших distinct/перцентилей — `approx_distinct`, `approx_percentile` (если допустима приблизительность).
- Группируй по необходимому минимуму полей; лишние измерения резко увеличивают кардинальность.

### Оконные функции
- Сужай `PARTITION BY`/`ORDER BY` до минимума; проверяй, можно ли заменить на предварительную агрегацию.
- Избегай окон над огромными наборами без фильтров/предагрегации.

### Партиции и pushdown
- Фильтры по партиционным колонкам формулируй без функций на колонках.
- Переноси функцию на константу: `ts >= timestamp '2023-01-01' AND ts < timestamp '2023-02-01'` вместо `month(ts) = 1`.
- Ограничивай период и `LIMIT` в интерактивных сценариях.

### CTE и подзапросы
- Помни: CTE в Trino — это inline; они не материализуются.
- Если тяжёлый подзапрос используется многократно — вынеси в материализованное представление/временную таблицу.

### Строковые операции и фильтры
- Избегай `LIKE '%pattern'`; используй префиксные матчи или специализированные структуры.
- Объединяй множественные `OR` одной колонки в `IN (...)`.

### Trino‑специфика и свойства сессии
- Дистрибуция JOIN: по умолчанию `AUTOMATIC`, но для уверенности можно устанавливать `'BROADCAST'`/`'PARTITIONED'`.
- Разрешай reordering joinов, включай dynamic filtering.
- Нет SQL‑хинтов — используем свойства сессии или переписывание запроса.

### Паттерны «видишь → предложи»
- `WHERE date(ts) = ...` → завести колонку `event_date` и фильтровать по ней либо диапазоном по `ts`.
- JOIN большой факт + маленький справочник → рекомендовать broadcast и предагрегацию справочника.
- Повторяющийся тяжёлый подзапрос → материализованное представление + `REFRESH` по расписанию.
- Подзапрос с `ORDER BY` без `LIMIT` → удалить `ORDER BY`.
- Много мелких файлов/партиций в источнике → рекомендовать компакшн/OPTIMIZE на уровне DDL.
- `SELECT *` → перечислить явные колонки и убрать вычисления, которые не используются.


