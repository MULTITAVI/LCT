## Best practices для DDL/схемы под Trino

Ниже — консолидированные подсказки для LLM‑агента при проектировании/оптимизации схемы данных (Hive/Iceberg/Delta) и физической организации под Trino.

### Хранилище и формат
- **Выбор таблицового формата**: предпочитай Iceberg (или Delta) поверх «сырого» Hive для эволюции схемы, ACID‑операций, компакшна, time travel, hidden partitioning, материализованных представлений.
- **Форматы файлов**: Parquet/ORC с колонковой компрессией (ZSTD/SNAPPY). Выставляй `compression` в параметрах таблицы/каталога.
- **Стабильность типов**: избегай хранения чисел/дат в `varchar`. Используй точные типы (`bigint`, `decimal(p,s)`, `timestamp [with time zone]`).

### Партиционирование
- Выбирай 1–3 наиболее селективные колонки, по которым чаще всего фильтруют.
- Избегай функций над колонками в запросах: лучше завести предвычисленные колонки `event_date`, `event_month`, `event_hour` и фильтровать по ним.
- Не создавай слишком мелкие партиции (высокая кардинальность → миллионы маленьких файлов).
- Для Iceberg рекомендуй hidden partitioning или `PARTITIONED BY` с предвычисленными колонками.

### Бакетизация
- Используй бакеты для колоночных join‑ключей, если есть частые объединения по одним ключам.
- Число бакетов согласуй с типичной степенью параллелизма кластера (кратно числу воркеров/слотов).
- Не смешивай разные bucket‑числа при перезаписи одной и той же логической таблицы.

### Размер и количество файлов
- Цель: 256MB–1GB на файл. Избегай миллионов «мелких файлов».
- При регулярной загрузке включай **компакшн**: для Iceberg `ALTER TABLE <t> EXECUTE optimize` (или настрой задания компакшна).
- Для CTAS/INSERT настраивай желаемый целевой размер файла (`writer_target_file_size`, если поддерживает коннектор).

### Статистика и метаданные
- Регулярно выполняй `ANALYZE <table>` (если поддерживается коннектором) для актуальных колоночных статов.
- Для Hive‑каталога поддерживай синхронизацию партиций: `CALL system.sync_partition_metadata(...)`.

### Материализованные представления и агрегаты
- Для тяжелых, часто повторяющихся агрегаций и предобъединений предлагай `CREATE MATERIALIZED VIEW` и регулярный `REFRESH MATERIALIZED VIEW`.
- Старайся располагать MVs в том же каталоге, что и исходные данные, чтобы работал pushdown.

### Эволюция схемы
- Меняй большие таблицы поэтапно: создавай новую таблицу (CTAS) → backfill → переключение/переименование.
- Добавление колонок — безопасно; изменение типов/семантики — через новую колонку с последующей миграцией.

### Политики мульти‑тенантности и доступов
- Фиксируй `tenant_id`/бизнес‑ключи в схеме; гарантируй фильтры в представлениях.
- Запрещай кросс‑схемные обращения без явного разрешения; используй view‑слои.

### Практики загрузки
- Придерживайся CTAS/INSERT‑потока, который пишет сразу в целевой формат/партиции нужного размера.
- Планируй backfill «последовательно по партициям», чтобы избежать избыточных блокировок/нагрузки.

### Диагностика и обслуживание
- Мониторь число файлов на партицию и их средний размер; автоматизируй компакшн.
- Следи за долей «горячих» ключей (skew); при перекосе — пересбалансируй бакеты или храни «соль» (salting).


